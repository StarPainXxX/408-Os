## I/O设备的基本概念和分类

- 特性分类
	- 人机交互类外部设备
	- 存储设备
	- 网络通信设备
- 传输速率分类
	- 低速设备
	- 中速设备
	- 高速设备
- 按信息交换的单位分类
	- 块设备(传输快，可寻址)
	- 字符设备(传输慢，不可寻址，常采用中断驱动方式)

## I/O控制器

- 主要功能
	- 接受和识别CPU发出的命令(要有控制寄存器)
	- 向CPU报告设备的状态(要有状态寄存器)
	- 数据交换(要有数据寄存器,暂存输入/输出的数据)
	- 地址识别(由I/O逻辑实现)
- 组成
	- CPU与控制器之间的接口(实现控制器与CPU之间的通信)
	- I/O逻辑(负责识别CPU发出的命令,并向设备发出命令)
	- 控制器与设备之间的接口(实现控制器与设备之间的通信)
- 两种寄存器编址方式
	- 内存映射I/O
		- 控制器中的寄存器与内存同一编制
		- 可以采用对内存进行操作的指令来对控制器进行操作
	- 寄存器独立编址
		- 控制器中的寄存器独立编制
		- 器制控作操来令指的门专置设要需
## I/O控制方式

- 程序直接控制方式
	- 完成一次读/写的过程
		- CPU发出I/O命令后需要不断轮询
	- CPU干预频率
		- 极高
	- 每次I/O的数据传输单位：字
	- 数据流向
		- 设备→CPU→内存
		- 内存→CPU→设备
- 中断驱动方式
	- 完成一次读/写的过程
		- CPU发出I/O命令后可以做其他事,本次I/O完成后设备控制器发出中断信号
	- CPU干预频率
		- 高
	- 每次I/O的数据传输单位：字
	- 数据流向
		- 设备→CPU→内存
		- 内存→CPU→设备
- DMA方式
	- 完成一次读/写的过程
		- CPU发出I/O命令后可以做其他事,本次I/O完成后DMA控制器发出中断信号
	- CPU干预频率
		- 中
	- 每次I/O的数据传输单位：块
	- 数据流向
		- 设备→内存
		- 内存→设备
- 通道控制方式
	- 完成一次读/写的过程
		- CPU发出I/O命令后可以做其他事。通道会执行通道程序以完成I/O,完成后通道向CPU发出中断信号
	- CPU干预频率
		- 低
	- 每次I/O的数据传输单位：一组块
	- 数据流向
		- 设备→内存
		- 内存→设备
## I/O软件层次结构

- 用户层软件
	- 实现与用户交互的接口,向上提供方便易用的库函数
- 设备独立性软件
	1. 向上层提供统一的调用接口(如read/write系统调用);
	2. 设备的保护; 
	3. 差错处理;
	4. 设备的分配与回收;
	5. 数据缓冲区管理;
	6. 建立逻辑设备名到物理设备名的映射关系;根据设备类型选择调用相应的驱动程序 ….(逻辑设备表的作用)
- 设备驱动程序
	- 设置设备寄存器、检查设备状态
- 中断处理程序
	- 进行中断处理
- 硬件
	- 执行I/O操作,有机械部件、电子部件组成(参考“I/O控制器”小节的视频)

## 输入输出应用程序接口和驱动程序接口

- 输入输出应用程序接口
	- 字符设备接口
		- get/put 系统调用:向字符设备读/写一个字符
	- 块设备接口
		- read/write 系统调用:向块设备的读写指针位置读/写多个字符;seek系统调用:修改读写指针位置
	- 网络设备接口(网络套接字socket接口)
		- socket 系统调用:创建一个网络套接字,需指明网络协议(TCP?UDP?)bind:将套接字绑定到某个本地“端口”connect:将套接字连接到远程地址read/write:从套接字读/写数据
	- 阻塞I/O:应用程序发出I/O系统调用,进程需转为阻塞态等待。
	- 非阻塞I/O:应用程序发出I/O系统调用，系统调用可迅速返回，进程无需阻塞等待
	- 设备驱动程序接口

## I/O核心子系统

- 假脱机技术(SPOOLing技术)
- I/O调度
- 设备保护
- 设备分配与回收
- 缓冲区管理(即缓冲与高速缓存)

## 假脱机技术(SPOOLing技术)

-  脱机技术
	- 外围控制机+更高速的设备 -- 磁带
	- 作用:缓解设备与CPU的速度矛盾,实现预输入、缓输出
- 假脱机技术
	- 又叫SPOOLing技术,用软件的方式模拟脱机技术
	- 输入井和输出井 -- 模拟脱机输入/输出时的磁带
	- 输入进程和输出进程 -- 模拟脱机输入/输出时的外围控制机
	- 输入缓冲区和输出缓冲区 -- 内存中的缓冲区,输入、输出时的“中转站”
- 共享打印机
	- 用SPOOLing技术将独占式的打印机“虚拟”成共享打印机

## 设备的分配与回收

-   应考虑的因素
	- 固有属性
		- 独占设备、共享设备、虚拟设备(SPOOLing)
	- 分配算法
		- 先来先服务、优先级高者优先、短任务优先等
	- 安全性
		- 安全分配方式、不安全分配方式
- 静态分配与动态分配
	- 静态分配:进程运行前为其分配全部所需资源,运行结束后归还资源
	- 动态分配:进程运行过程中动态申请设备资源
- 设备分配管理中的数据结构
	- 设备控制表(DCT)
		- 每个设备对应一张DCT,关键字段:类型/标识符/状态/指向COCT的指针/等待队列指针
	- 控制器控制表(COCT)
		- 每个控制器对应一张COCT,关键字段:状态/指向CHCT的指针/等待队列指针
	- 通道控制表(CHCT)
		- 每个控制器对应一张CHCT,关键字段:状态/等待队列指针
	- 系统设备表(SDT)
		- 记录整个系统中所有设备的情况,每个设备对应一个表目,关键字段;设备类型/标识符/DCT/驱动程序入口
- 设备分配的步骤
	- 根据进程请求的物理设备名查找SDT;根据SDT找到DCT并分配设备;根据DCT找到COCT并分配控制器;根据COCT找到CHCT并分配通道
	- 注:只有设备、控制器、通道三者都分配成功时,这次设备分配才算成功,之后便可启动I/O设备进行数据传送
	- 缺点:用户编程时必须使用“物理设备名”,若换了一个物理设备,则程序无法运行。若进程请求的物理设备正在忙碌,则即使系统中还有同类型的设备,进程也必须阻塞等待
- 设备分配步骤的改进
	- 用户编程时使用逻辑设备名申请设备,操作系统负责实现从逻辑设备名到物理设备名的映射(通过LUT)
	- 逻辑设备表的设置问题
		- 整个系统只有一张LUT:各用户所用的逻辑设备名不允许重复
		- 每个用户一张LUT:各个用户的逻辑设备名可重复

## 缓冲区管理

- 缓冲区的概念
	- 一般利用内存作为缓冲区
	- 缓解CPU与设备的速度矛盾、减少对CPU的中断频率、解决数据粒度不匹配的问题、提高CPU与I/O设备之间的并行性
- 单缓冲
	- 设备-(T)一缓冲区一(M)一工作区一(C)一处理
	- 处理一块数据平均耗时Max(C,T)+M
	- 分析问题的初始状态:工作区满,缓冲区空
- 双缓冲
	- 处理一块数据平均耗时 Max(T,C+M)
	- 分析问题的初始状态:工作区空,一个缓冲区满,另一个缓冲区空
- 循环缓冲
	- 多个缓冲区链接成循环队列,in指针指向第一个空缓冲区,out指针指向第一个满缓冲区
- 缓冲池
	- 三个队列:空缓冲队列、输入队列、输出队列
	- 四种工作缓冲区
		- 用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区
		- 用于收容输出数据的工作缓冲区、用于提取输出数据的工作缓冲区

## 磁盘的结构

-  磁盘、磁道、扇区的概念
	- 磁盘由表面涂有磁性物质的圆形盘片组成
	- 每个盘片被划分为一个个磁道,每个磁道又划分为一个个扇区
- 如何在磁盘中读/写数据
	- 磁头移动到目标位置,盘片旋转,对应扇区划过磁道才能完成读/写
- 盘面、柱面的概念
	- 磁盘有多个盘片“摞”起来,每个盘片有两个盘面
	- 所有盘面中相对位置相同的磁道组成柱面
- 磁盘的物理地址
	- (柱面号,盘面号,扇区号)
- 磁盘的分类
	- 根据磁头是否可移动
		- 固定头磁盘(每个磁道有一个磁头)
		- 移动头磁盘(每个盘面只有一个磁头)
	- 根据盘片是否可更换
		- 固定盘磁盘
		- 可换盘磁盘
## 磁盘调度算法

- 一次磁盘读/写操作需要的时间
	- 寻找时间(寻道时间)Ts:在读/写数据前,将磁头移动到指定磁道所花的时间。
		- 启动磁头臂是需要时间的。假设耗时为s;
		- 移动磁头也是需要时间的。假设磁头匀速移动,每跨越一个磁道耗时为m,总共需要跨越n条磁道。则: 
			- 寻道时间$Tc=s+m*n$
	- 延迟时间TR:通过旋转磁盘,使磁头定位到目标扇区所需要的时间。设磁盘转速为r(单位:转/秒,或转/分),则平均所需的延迟时间$TR=(1/2)*(1/r)=1/2r$
	- 传输时间T1:从磁盘读出或向磁盘写入数据所经历的时间,假设磁盘转速为r,此次读/写的字节数为b,每个磁道上的字节数为N。则:传输时间$Tt=(1/r)*(b/N)=b/(rN)$
- 先来先服务算法(FCFS)
	- ![[Pasted image 20240625135430.png]]
- 最短寻找时间优先(SSTF)
	- ![[Pasted image 20240625135707.png]]
- 扫描算法
	- ![[Pasted image 20240625140131.png]]
- LOOK调度算法
	- ![[Pasted image 20240625140248.png]]
- 循环扫描算法(C-SCAN)
	- ![[Pasted image 20240625140506.png]]
- C-LOOK算法
	- ![[Pasted image 20240625140633.png]]



## 减少磁盘延迟时间的方法

- 交替编号
	- 具体做法:让编号相邻的扇区在物理上不相邻
	- 原理:读取完一个扇区后需要一段时间处理才可以继续读入下一个扇区
- 错位命名
	- 具体做法:让相邻盘面的扇区编号“错位”
	- 原理:与“交替编号”的原理相同。“错位命名法”可降低延迟时间
- 磁盘地址结构的设计
	- 理解为什么要用(柱面号,盘面号,扇区号)的结构
	- 理解为什么不用(盘面号,柱面号,扇区号)的结构
	- 原因:在读取地址连续的磁盘块时,前者更不需要移动磁头
## 磁盘的管理

- 磁盘初始化
	- 低级格式化/物理格式化:划分扇区
	- 磁盘分区(C盘、D盘、E盘)
	- 逻辑格式化:建立文件系统(建立根目录文件、建立用于存储空间管理的数据结构)
- 引导块
	- 计算机启动时需要运行初始化程序(自举程序)来完成初始化
	- ROM中存放很小的自举装入程序
	- 完整的自举程序存放在初始块(引导块)中
- 坏块的管理
	- 简单的磁盘:逻辑格式化时将坏块标记出来
	- 复杂的磁盘:磁盘控制器维护一个坏块链,并管理备用扇区
## 固态硬盘SSD

- 原理-基于闪存技术 Flash Memory,属于电可擦除ROM,即EEPROM
- 组成
	- 闪存翻译层-负责翻译逻辑块号,找到对应页(Page)
	- 存储介质:多个闪存芯片(Flash Chip)-每个芯片包含多个块(block)-每个块包含多个页(page)
- 读写性能特性
	- 以页(page)为单位读/写-相当于磁盘的“扇区”
	- 以块(block)为单位“擦除”,擦干净的块,其中的每页都可以写一次,读无限次
	- 支持随机访问,系统给定一个逻辑地址,闪存翻译层可通过电路迅速定位到对应的物理地址
	- 读快、写慢。要写的页如果有数据,则不能写入,需要将块内其他页全部复制到一个新的(擦除过的)块中,再写入新的页
- 与机械硬盘相比的特点
	- SSD读写速度快,随机访问性能高,用电路控制访问位置;机械硬盘通过移动磁臂旋转磁盘控制访问位置,有寻道时间和旋转延迟
	- SSD安静无噪音、耐摔抗震、能耗低、造价更贵
	- SSD的一个“块”被擦除次数过多(重复写同一个块)可能会坏掉,而机械硬盘的扇区不会因为写的次数太多而坏
- 磨损均衡技术
	- 思想:将“擦除”平均分布在各个块上,以提升使用寿命
	- 动态磨损均衡-写入数据时,优先选择累计擦除次数少的新闪存块
	- 静态磨损均衡
		- SSD监测并自动进行数据分配、迁移,让老旧的闪存块承担以读为主的储存任务,让较新的闪存块承担更多的写任务